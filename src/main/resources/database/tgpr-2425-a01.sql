drop database if exists `tgpr-2425-a01`;
CREATE
    DATABASE IF NOT EXISTS `tgpr-2425-a01`;
USE
    `tgpr-2425-a01`;

CREATE TABLE users
(
    id        INT AUTO_INCREMENT PRIMARY KEY,
    full_name VARCHAR(255)                    NOT NULL UNIQUE,
    email     VARCHAR(255)                    NOT NULL UNIQUE,
    password  VARCHAR(255)                    NOT NULL,
    role      enum ('user', 'admin', 'guest') NOT NULL
);

INSERT INTO `users` (`id`, `email`, `password`, `full_name`, role)
VALUES (1, 'bepenelle@epfc.eu', '56ce92d1de4f05017cf03d6cd514d6d1', 'Benoît Penelle', 'user'),
       (2, 'mamichel@epfc.eu', '56ce92d1de4f05017cf03d6cd514d6d1', 'Marc Michel', 'user'),
       (3, 'xapigeolet@epfc.eu', '56ce92d1de4f05017cf03d6cd514d6d1', 'Xavier Pigeolet', 'user'),
       (4, 'boverhaegen@epfc.eu', '56ce92d1de4f05017cf03d6cd514d6d1', 'Boris Verhaegen', 'user'),
       (5, 'admin@epfc.eu', '56ce92d1de4f05017cf03d6cd514d6d1', 'Administrator', 'admin'),
       (6, 'student1@epfc.eu', '56ce92d1de4f05017cf03d6cd514d6d1', 'Student #1', 'user'),
       (7, 'student2@epfc.eu', '56ce92d1de4f05017cf03d6cd514d6d1', 'Student #2', 'user'),
       (8, 'student3@epfc.eu', '56ce92d1de4f05017cf03d6cd514d6d1', 'Student #3', 'user'),
       (9, 'guest@epfc.eu', '56ce92d1de4f05017cf03d6cd514d6d1', 'Anonymous User', 'guest');

CREATE TABLE forms
(
    id          INT AUTO_INCREMENT PRIMARY KEY,
    title       VARCHAR(255) NOT NULL,
    description TEXT,
    owner       INT          NOT NULL,
    is_public   tinyint      NOT NULL DEFAULT 0,
    FOREIGN KEY (owner) REFERENCES users (id) on delete cascade,
    unique(owner, title)   -- risque de doublon à cause du partage, mais owner différents : ok
);

insert into forms (id, title, description, owner, is_public)
values (1, 'Data sheet', 'This form is intended to collect your administrative information.', 1, 1),
       (2, 'Form 01', 'Test form 1', 1, 0),
       (3, 'Form 02', 'Test form 2', 2, 0),
       (4, 'Form 03', 'Test form 3', 1, 0),
       (5, 'Form 04', 'Test form 4', 1, 0),
       (6, 'Form 05', 'Test form 5', 1, 0),
       (7, 'Form 06', 'Test form 6', 1, 0),
       (8, 'Form 07', 'Test form 7', 1, 0),
       (9, 'Form 08', 'Test form 8', 1, 0),
       (10, 'Form 09', 'Test form 9', 1, 0),
       (11, 'Form 10', 'Test form 10', 1, 0),
       (12, 'Form 11', 'Test form 11', 1, 0),
       (13, 'Form 12', 'Test form 12', 1, 0),
       (14, 'Abc', 'Test form', 1, 0),
       (15, 'Aaa', 'Short test form', 1, 1);

CREATE TABLE user_form_accesses
(
    user        INT                    NOT NULL,
    form        INT                    NOT NULL,
    access_type enum ('user','editor') NOT NULL,
    primary key (user, form),
    FOREIGN KEY (user) REFERENCES users (id) on delete cascade,
    FOREIGN KEY (form) REFERENCES forms (id) on delete cascade
);

insert into user_form_accesses (form, user, access_type)
values (2, 2, 'editor'),
       (2, 4, 'editor'),
       (2, 6, 'user'),
       (2, 7, 'user'),
       (2, 8, 'user'),
       (3, 1, 'editor'),
       (3, 4, 'editor'),
       (3, 6, 'user'),
       (3, 8, 'user'),
       (14, 2, 'editor'),
       (14, 4, 'user');

CREATE TABLE option_lists
(
    id    INT AUTO_INCREMENT PRIMARY KEY,
    name  varchar(255) NOT NULL,
    owner INT          NULL,
    FOREIGN KEY (owner) REFERENCES users (id) on delete cascade,
    unique(owner, name)
);

insert into option_lists (id, name, owner)
values (1, 'Gender', null),
       (2, 'Marital status', null),
       (3, 'Number of children', null),
       (4, 'Country', null),
       (5, 'Programming languages', 1),
       (6, 'Fruits', 1),
       (7, 'Age range', 1);

CREATE TABLE option_values
(
    option_list INT          NOT NULL,
    idx         int          not NULL,
    label       VARCHAR(255) NOT NULL,
    primary key (option_list, idx),
    unique (option_list, label),
    FOREIGN KEY (option_list) REFERENCES option_lists (id) on delete cascade
);

insert into option_values (option_list, idx, label)
values -- sexe
       (1, 1, 'Female'),
       (1, 2, 'Male'),
       (1, 3, 'Other'),
-- marital status
       (2, 1, 'Single'),
       (2, 2, 'Married'),
       (2, 3, 'Divorced'),
       (2, 4, 'Widowed'),
-- number of children
       (3, 1, 'None'),
       (3, 2, '1'),
       (3, 3, '2'),
       (3, 4, '3'),
       (3, 5, '4'),
       (3, 6, '5'),
       (3, 7, 'More than 5'),
       -- pays
       (4, 1, 'Afghanistan'),
       (4, 2, 'Albania'),
       (4, 3, 'Algeria'),
       (4, 4, 'Andorra'),
       (4, 5, 'Angola'),
       (4, 6, 'Antigua and Barbuda'),
       (4, 7, 'Argentina'),
       (4, 8, 'Armenia'),
       (4, 9, 'Australia'),
       (4, 10, 'Austria'),
       (4, 11, 'Azerbaijan'),
       (4, 12, 'Bahamas'),
       (4, 13, 'Bahrain'),
       (4, 14, 'Bangladesh'),
       (4, 15, 'Barbados'),
       (4, 16, 'Belarus'),
       (4, 17, 'Belgium'),
       (4, 18, 'Belize'),
       (4, 19, 'Benin'),
       (4, 20, 'Bhutan'),
       (4, 21, 'Bolivia'),
       (4, 22, 'Bosnia and Herzegovina'),
       (4, 23, 'Botswana'),
       (4, 24, 'Brazil'),
       (4, 25, 'Brunei'),
       (4, 26, 'Bulgaria'),
       (4, 27, 'Burkina Faso'),
       (4, 28, 'Burundi'),
       (4, 29, 'Cabo Verde'),
       (4, 30, 'Cambodia'),
       (4, 31, 'Cameroon'),
       (4, 32, 'Canada'),
       (4, 33, 'Central African Republic'),
       (4, 34, 'Chad'),
       (4, 35, 'Chile'),
       (4, 36, 'China'),
       (4, 37, 'Colombia'),
       (4, 38, 'Comoros'),
       (4, 39, 'Congo'),
       (4, 40, 'Costa Rica'),
       (4, 41, 'Croatia'),
       (4, 42, 'Cuba'),
       (4, 43, 'Cyprus'),
       (4, 44, 'Czech Republic'),
       (4, 45, 'Denmark'),
       (4, 46, 'Djibouti'),
       (4, 47, 'Dominica'),
       (4, 48, 'Dominican Republic'),
       (4, 49, 'Ecuador'),
       (4, 50, 'Egypt'),
       (4, 51, 'El Salvador'),
       (4, 52, 'Equatorial Guinea'),
       (4, 53, 'Eritrea'),
       (4, 54, 'Estonia'),
       (4, 55, 'Eswatini'),
       (4, 56, 'Ethiopia'),
       (4, 57, 'Fiji'),
       (4, 58, 'Finland'),
       (4, 59, 'France'),
       (4, 60, 'Gabon'),
       (4, 61, 'Gambia'),
       (4, 62, 'Georgia'),
       (4, 63, 'Germany'),
       (4, 64, 'Ghana'),
       (4, 65, 'Greece'),
       (4, 66, 'Grenada'),
       (4, 67, 'Guatemala'),
       (4, 68, 'Guinea'),
       (4, 69, 'Guinea-Bissau'),
       (4, 70, 'Guyana'),
       (4, 71, 'Haiti'),
       (4, 72, 'Honduras'),
       (4, 73, 'Hungary'),
       (4, 74, 'Iceland'),
       (4, 75, 'India'),
       (4, 76, 'Indonesia'),
       (4, 77, 'Iran'),
       (4, 78, 'Iraq'),
       (4, 79, 'Ireland'),
       (4, 80, 'Israel'),
       (4, 81, 'Italy'),
       (4, 82, 'Ivory Coast'),
       (4, 83, 'Jamaica'),
       (4, 84, 'Japan'),
       (4, 85, 'Jordan'),
       (4, 86, 'Kazakhstan'),
       (4, 87, 'Kenya'),
       (4, 88, 'Kiribati'),
       (4, 89, 'Kuwait'),
       (4, 90, 'Kyrgyzstan'),
       (4, 91, 'Laos'),
       (4, 92, 'Latvia'),
       (4, 93, 'Lebanon'),
       (4, 94, 'Lesotho'),
       (4, 95, 'Liberia'),
       (4, 96, 'Libya'),
       (4, 97, 'Liechtenstein'),
       (4, 98, 'Lithuania'),
       (4, 99, 'Luxembourg'),
       (4, 100, 'Madagascar'),
       (4, 101, 'Malawi'),
       (4, 102, 'Malaysia'),
       (4, 103, 'Maldives'),
       (4, 104, 'Mali'),
       (4, 105, 'Malta'),
       (4, 106, 'Marshall Islands'),
       (4, 107, 'Mauritania'),
       (4, 108, 'Mauritius'),
       (4, 109, 'Mexico'),
       (4, 110, 'Micronesia'),
       (4, 111, 'Moldova'),
       (4, 112, 'Monaco'),
       (4, 113, 'Mongolia'),
       (4, 114, 'Montenegro'),
       (4, 115, 'Morocco'),
       (4, 116, 'Mozambique'),
       (4, 117, 'Myanmar'),
       (4, 118, 'Namibia'),
       (4, 119, 'Nauru'),
       (4, 120, 'Nepal'),
       (4, 121, 'Netherlands'),
       (4, 122, 'New Zealand'),
       (4, 123, 'Nicaragua'),
       (4, 124, 'Niger'),
       (4, 125, 'Nigeria'),
       (4, 126, 'North Korea'),
       (4, 127, 'North Macedonia'),
       (4, 128, 'Norway'),
       (4, 129, 'Oman'),
       (4, 130, 'Pakistan'),
       (4, 131, 'Palau'),
       (4, 132, 'Panama'),
       (4, 133, 'Papua New Guinea'),
       (4, 134, 'Paraguay'),
       (4, 135, 'Peru'),
       (4, 136, 'Philippines'),
       (4, 137, 'Poland'),
       (4, 138, 'Portugal'),
       (4, 139, 'Qatar'),
       (4, 140, 'Romania'),
       (4, 141, 'Russia'),
       (4, 142, 'Rwanda'),
       (4, 143, 'Saint Kitts and Nevis'),
       (4, 144, 'Saint Lucia'),
       (4, 145, 'Saint Vincent and the Grenadines'),
       (4, 146, 'Samoa'),
       (4, 147, 'San Marino'),
       (4, 148, 'Sao Tome and Principe'),
       (4, 149, 'Saudi Arabia'),
       (4, 150, 'Senegal'),
       (4, 151, 'Serbia'),
       (4, 152, 'Seychelles'),
       (4, 153, 'Sierra Leone'),
       (4, 154, 'Singapore'),
       (4, 155, 'Slovakia'),
       (4, 156, 'Slovenia'),
       (4, 157, 'Solomon Islands'),
       (4, 158, 'Somalia'),
       (4, 159, 'South Korea'),
       (4, 160, 'South Sudan'),
       (4, 161, 'Spain'),
       (4, 162, 'Sri Lanka'),
       (4, 163, 'Sudan'),
       (4, 164, 'Suriname'),
       (4, 165, 'Sweden'),
       (4, 166, 'Switzerland'),
       (4, 167, 'Syria'),
       (4, 168, 'Tajikistan'),
       (4, 169, 'Tanzania'),
       (4, 170, 'Thailand'),
       (4, 171, 'Timor-Leste'),
       (4, 172, 'Togo'),
       (4, 173, 'Tonga'),
       (4, 174, 'Trinidad and Tobago'),
       (4, 175, 'Tunisia'),
       (4, 176, 'Turkey'),
       (4, 177, 'Turkmenistan'),
       (4, 178, 'Tuvalu'),
       (4, 179, 'Uganda'),
       (4, 180, 'Ukraine'),
       (4, 181, 'United Arab Emirates'),
       (4, 182, 'United Kingdom'),
       (4, 183, 'United States'),
       (4, 184, 'Uruguay'),
       (4, 185, 'Uzbekistan'),
       (4, 186, 'Vanuatu'),
       (4, 187, 'Vatican'),
       (4, 188, 'Venezuela'),
       (4, 189, 'Vietnam'),
       (4, 190, 'Yemen'),
       (4, 191, 'Zambia'),
       (4, 192, 'Zimbabwe'),
       -- langages informatiques
       (5, 1, 'C'),
       (5, 2, 'C#'),
       (5, 3, 'C++'),
       (5, 4, 'Dart'),
       (5, 5, 'Go'),
       (5, 6, 'Java'),
       (5, 7, 'JavaScript'),
       (5, 8, 'Kotlin'),
       (5, 9, 'MATLAB'),
       (5, 10, 'Objective-C'),
       (5, 11, 'Perl'),
       (5, 12, 'PHP'),
       (5, 13, 'Python'),
       (5, 14, 'R'),
       (5, 15, 'Ruby'),
       (5, 16, 'Rust'),
       (5, 17, 'Scala'),
       (5, 18, 'SQL'),
       (5, 19, 'Swift'),
       (5, 20, 'TypeScript'),
       -- fruits
       (6, 1, 'Apple'),
       (6, 2, 'Banana'),
       (6, 3, 'Cherry'),
       (6, 4, 'Clementine'),
       (6, 5, 'Currant'),
       (6, 6, 'Kiwi'),
       (6, 7, 'Mandarin'),
       (6, 8, 'Melon'),
       (6, 9, 'Orange'),
       (6, 10, 'Pear'),
       (6, 11, 'Pineapple'),
       (6, 12, 'Strawberry'),
       -- Age group
       (7, 1, '0 - 5'),
       (7, 2, '6 - 10'),
       (7, 3, '11 - 20'),
       (7, 4, '21 - 50'),
       (7, 5, '51 or more');

CREATE TABLE questions
(
    id          INT AUTO_INCREMENT PRIMARY KEY,
    form        INT                               NOT NULL,
    idx         INT                               NOT NULL,
    title       VARCHAR(255)                      NOT NULL,
    description TEXT,
    type        enum ('short','long','radio','check','combo','date','email') NOT NULL,
    required    BOOLEAN                           NOT NULL,
    option_list INT                               NULL,
    FOREIGN KEY (form) REFERENCES forms (id) on delete cascade,
    FOREIGN KEY (option_list) REFERENCES option_lists (id) on delete cascade,
    unique (form, idx),
    unique (form, title)
);

insert into questions (id, form, idx, title, description, type, required, option_list)
values (1, 1, 1, 'Your last name?', 'Your last name', 'short', 1, null),
       (2, 1, 2, 'Your first name?', 'Your first name', 'short', 1, null),
       (3, 1, 3, 'Your date of birth?', 'Your date of birth', 'date', 1, null),
       (4, 1, 4, 'Your place of birth?', 'Your place of birth', 'short', 0, null),
       (5, 1, 5, 'Your nationality?', 'Your nationality', 'combo', 1, 4),
       (6, 1, 6, 'Your address?', 'Your address', 'short', 0, null),
       (7, 1, 7, 'Your postal code?', 'Your postal code', 'short', 0, null),
       (8, 1, 8, 'Your city?', 'Your city of residence', 'short', 0, null),
       (9, 1, 9, 'Your country?', 'Your country of residence', 'combo', 0, 4),
       (10, 1, 10, 'Your phone number?', 'Your phone number', 'short', 0, null),
       (11, 1, 11, 'Your email address?', 'Your email address', 'email', 1, null),
       (12, 1, 12, 'Your gender?', 'Your gender', 'radio', 1, 1),
       (13, 1, 13, 'Your marital status?', 'Your marital status', 'combo', 1, 2),
       (14, 1, 14, 'How many children do you have?', 'Number of dependent children', 'combo', 1, 3),
       (15, 1, 15, 'Your profession?', 'Your profession', 'short', 0, null),
       (16, 1, 16, 'Do you have any comments for us?', null, 'long', 0, null),
       (17, 2, 1, 'Your favorite programming languages', null, 'check', 0, 5),
       (18, 2, 2, 'The programming languages you dislike the most', null, 'check', 1, 5),
       (19, 14, 1, 'Question 1', null, 'short', 1, null),
       (20, 14, 2, 'Question 2', null, 'long', 1, null),
       (21, 14, 3, 'Question 3', null, 'radio', 1, 6),
       (22, 14, 4, 'Question 4', null, 'check', 1, 6),
       (23, 14, 5, 'Question 5', null, 'combo', 1, 6),
       (24, 14, 6, 'Question 6', null, 'date', 1, null),
       (26, 14, 8, 'Question 8', null, 'email', 1, null),
       (28, 14, 10, 'Question 10', null, 'short', 0, null),
       (29, 14, 11, 'Question 11', null, 'long', 0, null),
       (30, 14, 12, 'Question 12', null, 'radio', 0, 6),
       (31, 14, 13, 'Question 13', null, 'check', 0, 6),
       (32, 14, 14, 'Question 14', null, 'combo', 0, 6),
       (33, 14, 15, 'Question 15', null, 'date', 0, null),
       (35, 14, 17, 'Question 17', null, 'email', 0, null),
       (37, 15, 1, 'Gender', 'required for statistical purposes', 'radio', 1, 1),
       (38, 15, 2, 'Age group', 'required for statistical purposes', 'combo', 1, 7),
       (39, 15, 3, 'Favorite animal', 'in lowercase, please', 'short', 0, null),
       (40, 15, 4, 'Favorite fruits', null, 'check', 0, 6);

CREATE TABLE instances
(
    id        INT AUTO_INCREMENT PRIMARY KEY,
    form      INT       NOT NULL,
    user      INT       NOT NULL,
    started   TIMESTAMP      DEFAULT CURRENT_TIMESTAMP,
    completed TIMESTAMP null DEFAULT null,
    FOREIGN KEY (form) REFERENCES forms (id) on delete cascade,
    FOREIGN KEY (user) REFERENCES users (id) on delete cascade
);

insert into instances (id, form, user, started, completed)
values (1, 15, 1, '2024-07-31 15:06:24', '2024-07-31 15:06:48'),
       (2, 15, 1, '2024-07-31 15:07:04', '2024-07-31 15:07:23'),
       (3, 15, 2, '2024-07-31 15:07:31', '2024-07-31 15:07:59'),
       (4, 15, 3, '2024-07-31 15:08:06', '2024-07-31 15:08:21'),
       (5, 15, 9, '2024-07-31 15:08:27', '2024-07-31 15:08:44'),
       (6, 15, 9, '2024-07-31 15:08:45', '2024-07-31 15:09:00'),
       (7, 15, 9, '2024-07-31 15:09:01', '2024-07-31 15:09:26'),
       (8, 1, 1, '2024-07-31 15:11:04', null),
       (9, 1, 9, '2024-07-31 15:21:00', null),
       (10, 1, 9, '2024-07-31 15:21:00', '2024-07-31 15:31:00');

CREATE TABLE answers
(
    instance INT  NOT NULL,
    question INT  NOT NULL,
    idx      INT  NOT NULL DEFAULT 0,
    value    TEXT NOT NULL,
    primary key (instance, question, idx),
    FOREIGN KEY (instance) REFERENCES instances (id) on delete cascade,
    FOREIGN KEY (question) REFERENCES questions (id) on delete cascade
);

insert into answers (instance, question, idx, value)
values (1, 37, 0, '2'),
       (1, 38, 0, '5'),
       (1, 39, 0, 'cat'),
       (1, 40, 1, '3'),
       (1, 40, 2, '6'),
       (1, 40, 3, '9'),
       (2, 37, 0, '2'),
       (2, 38, 0, '5'),
       (2, 39, 0, 'dog'),
       (2, 40, 1, '3'),
       (2, 40, 2, '4'),
       (2, 40, 3, '5'),
       (3, 37, 0, '2'),
       (3, 38, 0, '4'),
       (3, 39, 0, 'goldfish'),
       (3, 40, 1, '1'),
       (3, 40, 2, '3'),
       (3, 40, 3, '10'),
       (4, 37, 0, '2'),
       (4, 38, 0, '4'),
       (4, 39, 0, ''),
       (4, 40, 1, '4'),
       (5, 37, 0, '1'),
       (5, 38, 0, '3'),
       (5, 39, 0, 'dog'),
       (5, 40, 1, '1'),
       (5, 40, 2, '2'),
       (5, 40, 3, '7'),
       (5, 40, 4, '8'),
       (6, 37, 0, '2'),
       (6, 38, 0, '2'),
       (6, 39, 0, 'cat'),
       (6, 40, 1, '1'),
       (6, 40, 2, '3'),
       (7, 37, 0, '3'),
       (7, 38, 0, '4'),
       (7, 39, 0, 'pterodactyl');

CREATE TABLE distlists
(
    id          INT AUTO_INCREMENT PRIMARY KEY,
    name        VARCHAR(255) NOT NULL,
    description TEXT,
    owner       int          not null,
    foreign key (owner) references users (id) on delete cascade,
    unique(owner, name)
);

insert into distlists (id, name, description, owner)
values (1, 'List 1', 'Distribution list 1', 1),
       (2, 'List 2', 'Distribution list 2', 1),
       (3, 'List 3', 'Distribution list 3', 2);

CREATE TABLE distlist_users
(
    distlist INT NOT NULL,
    user     INT NOT NULL,
    primary key (distlist, user),
    FOREIGN KEY (distlist) REFERENCES distlists (id) on delete cascade,
    FOREIGN KEY (user) REFERENCES users (id) on delete cascade
);

insert into distlist_users (distlist, user)
values (1, 2),
       (1, 3),
       (1, 4),
       (1, 6),
       (1, 8),
       (2, 3),
       (2, 5),
       (3, 1),
       (3, 4);

CREATE TABLE distlist_form_accesses
(
    distlist    INT                    NOT NULL,
    form        INT                    NOT NULL,
    access_type enum ('user','editor') NOT NULL,
    primary key (distlist, form),
    FOREIGN KEY (distlist) REFERENCES distlists (id) on delete cascade,
    FOREIGN KEY (form) REFERENCES forms (id) on delete cascade
);

insert into distlist_form_accesses (distlist, form, access_type)
values (1, 14, 'user');
